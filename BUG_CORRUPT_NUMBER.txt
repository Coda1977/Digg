# BUG: Corrupt Number Causing PDF Crash
## Error: `unsupported number: -9.44473296573929e+21`

## Status: ROOT CAUSE IDENTIFIED - react-pdf internal overflow

## Session 3 (Jan 8, 2026) - Critical Finding

### THE CORRUPT VALUE IS NOT IN OUR DATA OR TEXT CONTENT

Text-by-text logging revealed:
```
[TEXT #1] through [TEXT #319] - ALL logged successfully
Error: unsupported number: -9.44473296573929e+21
```

**All 319 text elements rendered and logged without issue.**
The crash occurs AFTER all text processing, during react-pdf's final layout phase.

### Stack Trace Analysis
```
at number (...)
at I4.transform (...)  <-- Transformation matrix
at I4.translate (...)  <-- Coordinate translation
at TEXT (...)
```

### Root Cause: Coordinate Overflow in react-pdf

The `-9.44e21` value is an **arithmetic overflow** in react-pdf's internal coordinate system.
It's NOT caused by:
- ❌ Our data values
- ❌ Any specific text content
- ❌ Special characters or Unicode

It IS caused by:
- ✅ react-pdf's internal layout calculations overflowing
- ✅ Cumulative coordinate math producing astronomically large numbers

### Why This Happens Across Multiple Surveys

User confirmed: "this issue across a few surveys, not just this survey"

Likely triggers:
1. **Long documents** - many pages cause y-coordinates to accumulate and overflow
2. **Hebrew/RTL text** - may have incorrect font metrics in built-in PDF fonts
3. **Page break logic** - pagination calculations may overflow
4. **Font fallback** - missing glyphs causing bad width/height calculations

### Key Observation
The document has:
- 6 transcripts with 30+ messages each
- Hebrew text mixed with English
- ~319 text elements total
- Multiple pages of content

### Fix Applied (Jan 8, 2026)

**Solution: Added Hebrew font support**

Root cause confirmed: Built-in PDF fonts (Helvetica, Times-Roman) don't support Hebrew.
When react-pdf calculates glyph metrics for unsupported characters, values overflow.

Fix:
1. Downloaded Noto Sans Hebrew font (Regular + Bold) to `/public/fonts/`
2. Registered with `Font.register()` in ProjectInsightsPdf.tsx
3. Changed FONT_SANS and FONT_SERIF to use "NotoHebrew"
4. NotoHebrew supports both Hebrew AND Latin characters

References:
- [Issue #1851](https://github.com/diegomura/react-pdf/issues/1851) - Empty string -Infinity
- [Issue #3010](https://github.com/diegomura/react-pdf/issues/3010) - Hebrew rendering
- [pdfkit RTL Issue #219](https://github.com/foliojs/pdfkit/issues/219) - RTL support

---

## Session 2 Findings (Jan 7, 2026)
- Scanned 42 numeric values in analysis, segmentedAnalysis, responsesByQuestion
- Only "suspicious" value: `analysis.generatedAt: 1767775422733` (valid timestamp - false positive)
- All checked data values were valid

## Database Checks Performed
All clean - no corrupt values found:
- projects.analysis.strengths[].frequency
- projects.analysis.coverage values
- projects.segmentedAnalysis values
- messages[].ratingValue
- templates[].questions[].ratingScale.max

## Fix Layers Implemented (defense in depth)
1. API Layer: logAllNumbers() in analyze route
2. Schema Layer: sanitizeFrequency/sanitizeCount in Zod preprocess
3. Convex Layer: sanitization in saveAnalysis mutation
4. PDF Layer: safeCount() and normalizeRating() guards
5. Migration: dryRun checks all tables (all clean!)

## Next Steps
1. Expand PDF logging to include `surveys` and `transcripts` props
2. Check if corrupt value is a font metric issue in react-pdf
3. Try removing sections of PDF to isolate which part causes crash

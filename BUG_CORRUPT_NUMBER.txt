# BUG: Corrupt Number Causing PDF Crash
## Error: `unsupported number: -9.44473296573929e+21`

## Status: ROOT CAUSE IDENTIFIED - react-pdf internal overflow

## Session 3 (Jan 8, 2026) - Critical Finding

### THE CORRUPT VALUE IS NOT IN OUR DATA OR TEXT CONTENT

Text-by-text logging revealed:
```
[TEXT #1] through [TEXT #319] - ALL logged successfully
Error: unsupported number: -9.44473296573929e+21
```

**All 319 text elements rendered and logged without issue.**
The crash occurs AFTER all text processing, during react-pdf's final layout phase.

### Stack Trace Analysis
```
at number (...)
at I4.transform (...)  <-- Transformation matrix
at I4.translate (...)  <-- Coordinate translation
at TEXT (...)
```

### Root Cause: Coordinate Overflow in react-pdf

The `-9.44e21` value is an **arithmetic overflow** in react-pdf's internal coordinate system.
It's NOT caused by:
- ❌ Our data values
- ❌ Any specific text content
- ❌ Special characters or Unicode

It IS caused by:
- ✅ react-pdf's internal layout calculations overflowing
- ✅ Cumulative coordinate math producing astronomically large numbers

### Why This Happens Across Multiple Surveys

User confirmed: "this issue across a few surveys, not just this survey"

Likely triggers:
1. **Long documents** - many pages cause y-coordinates to accumulate and overflow
2. **Hebrew/RTL text** - may have incorrect font metrics in built-in PDF fonts
3. **Page break logic** - pagination calculations may overflow
4. **Font fallback** - missing glyphs causing bad width/height calculations

### Key Observation
The document has:
- 6 transcripts with 30+ messages each
- Hebrew text mixed with English
- ~319 text elements total
- Multiple pages of content

### Fix Attempt #1: Hebrew Font Support (FAILED)

**Hypothesis:** Built-in PDF fonts don't support Hebrew, causing glyph metric overflow.

**What we did:**
1. Downloaded Noto Sans Hebrew font (Regular + Bold) to `/public/fonts/`
2. Registered with `Font.register()` including italic fallbacks
3. Changed FONT_SANS and FONT_SERIF to use "NotoHebrew"

**Result:** SAME ERROR - `-9.44473296573929e+21` still occurs!

**Conclusion:** Hebrew font support is NOT the root cause.
The overflow is happening somewhere else in react-pdf's layout engine.

### Current Status: Root Cause Still Unknown

The `-9.44e21` value is generated AFTER all 319 text elements render successfully.
It happens in the final PDF layout/composition phase, not during text rendering.

**What we've ruled out:**
- ❌ Our data values (all 54 numbers validated)
- ❌ Specific text content (all 319 texts logged before crash)
- ❌ Hebrew font support (added Noto Sans Hebrew, still crashes)

**Remaining possibilities:**
1. **Page break calculation overflow** - too many pages causing coordinate overflow
2. **Layout engine bug** in react-pdf with complex documents
3. **Specific CSS style combination** causing bad math
4. **Document structure** - nested Views/Pages causing accumulation

---

## Recommended Next Steps (8 Options)

### Investigation Options

**1. Binary Search (isolate the trigger)**
- Comment out PDF sections one by one (Transcripts, Analysis, Responses)
- Find which section causes the crash
- Pros: Pinpoints exact cause
- Cons: Time-consuming

**2. Check Specific Styles**
- The crash is in `transform/translate` - could be a CSS style combination
- Test removing styles like `wrap={false}`, `break`, absolute positioning
- Pros: Might find a simple fix
- Cons: Many styles to test

### Mitigation Options

**3. Limit Document Size**
- Cap transcripts to X per PDF, or split into multiple PDFs
- Pros: Quick workaround
- Cons: Doesn't fix root cause, limits functionality

**4. Try-Catch with Fallback**
- Catch the error, show user a message or offer alternative (e.g., "Download as text")
- Pros: Graceful degradation
- Cons: User doesn't get PDF

**5. Server-Side Generation**
- Generate PDF on server (Node.js) instead of browser
- Different environment might not have the bug
- Pros: Might just work
- Cons: Architecture change, more server load

### Library Options

**6. Upgrade/Downgrade react-pdf**
- Current: v4.3.1
- Try older stable version or check if newer version fixes it
- Pros: Might fix it
- Cons: Could introduce other issues

**7. Switch PDF Library**
- Alternatives: `jspdf`, `pdf-lib`, `puppeteer` (server-side)
- Pros: Fresh start, different rendering engine
- Cons: Significant rewrite

**8. Report Bug to react-pdf**
- File issue with reproduction case
- Pros: Community might have solution
- Cons: Slow, no guaranteed fix

### Recommendation
Start with **#1 (Binary Search)** - fastest to identify the trigger.
If that fails, **#5 (Server-Side)** is the most reliable workaround.

---

References:
- [Issue #1851](https://github.com/diegomura/react-pdf/issues/1851) - Empty string -Infinity
- [Issue #3010](https://github.com/diegomura/react-pdf/issues/3010) - Hebrew rendering
- [pdfkit RTL Issue #219](https://github.com/foliojs/pdfkit/issues/219) - RTL support

---

## Session 2 Findings (Jan 7, 2026)
- Scanned 42 numeric values in analysis, segmentedAnalysis, responsesByQuestion
- Only "suspicious" value: `analysis.generatedAt: 1767775422733` (valid timestamp - false positive)
- All checked data values were valid

## Database Checks Performed
All clean - no corrupt values found:
- projects.analysis.strengths[].frequency
- projects.analysis.coverage values
- projects.segmentedAnalysis values
- messages[].ratingValue
- templates[].questions[].ratingScale.max

## Fix Layers Implemented (defense in depth)
1. API Layer: logAllNumbers() in analyze route
2. Schema Layer: sanitizeFrequency/sanitizeCount in Zod preprocess
3. Convex Layer: sanitization in saveAnalysis mutation
4. PDF Layer: safeCount() and normalizeRating() guards
5. Migration: dryRun checks all tables (all clean!)

## Next Steps
1. Expand PDF logging to include `surveys` and `transcripts` props
2. Check if corrupt value is a font metric issue in react-pdf
3. Try removing sections of PDF to isolate which part causes crash
